name: Second Sync
on:
  repository_dispatch:
    types: [second_sync]

permissions: { contents: write }

# すべての run: を bash で実行（デフォルト指定）
defaults:
  run:
    shell: bash

concurrency:
  group: "philosophy-${{ github.event.client_payload.date || '' }}"
  cancel-in-progress: false

jobs:
  append:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - id: meta
        run: |
          set -euo pipefail
          DATE_JST=$(TZ=Asia/Tokyo date +%Y-%m-%d)
          echo "date=$DATE_JST" >> "$GITHUB_OUTPUT"
          BP="${{ github.event.client_payload.basePath }}"
          if [ -z "$BP" ]; then BP="ConversationLog/philosophy/"; fi
          echo "path=${BP}${DATE_JST}.md" >> "$GITHUB_OUTPUT"

      - name: De-dup
        id: dedup
        run: |
          set -euo pipefail
          mkdir -p .cache
          touch .cache/ids.txt
          ID="${{ github.event.client_payload.id }}"
          if [ -n "$ID" ] && grep -qxF "$ID" .cache/ids.txt; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Append content
        if: steps.dedup.outputs.skip != 'true'
        run: |
          set -euo pipefail
    mkdir -p "$(dirname "${{ steps.meta.outputs.path }}")"
    echo "${{ github.event.client_payload.content_b64 }}" | base64 -d >> "${{ steps.meta.outputs.path }}"
    if [ -n "${{ github.event.client_payload.id }}" ]; then
      echo "${{ github.event.client_payload.id }}" >> .cache/ids.txt
    fi

      - name: Commit
        if: steps.dedup.outputs.skip != 'true'
        run: |
          set -euo pipefail
          git config user.name "second-sync-bot"
          git config user.email "actions@users.noreply.github.com"
          git add -A
          git commit -m "chore(log): append ${{ steps.meta.outputs.path }}" || echo "No changes"
          git push
